/*! cjoop-ad-angular - v0.0.5 - 2016-09-10
* https://github.com/cjjava/cjoop-ad-angular
* Copyright (c) 2016 cjjava <85309651@qq.com>; Licensed MIT */
!function(a,b){"use strict";function c(){return a.adhost||"localhost:80"}function d(){return b.isArray(a.adData)&&a.adData.length>0}b.module("cjoop.ad",[]).directive("ad",["$http","$timeout",function(e,f){return{scope:{},template:function(a,c){var d=c.bindModel;if(!d)throw new Error("The bind-model must not be null");var e=d.split(","),f=new Array(e.length);return f.push('<div class="ad-wrapper">'),b.forEach(e,function(a,b){f.push('<select ng-change="change('+b+')" class="ad-select" ng-model="'+a+'" ng-options="'+a+".name for "+a+" in "+a+'s"></select>\n')}),f.push("</div>"),f.join("")},link:function(g,h,i){var j=i.bindModel,k=j.split(","),l=g.$parent,m={id:"",name:"请选择",$$index:-1};b.forEach(k,function(a,c){g[a+"s"]=[m],g[a]=m;var d=l[a];if(d||(d={id:"",name:"请选择"}),!b.isObject(d))throw new Error("scope."+a+"不是一个json对象.");d.$$index=c,l[a]=d}),g.refreshADInfo=function(a,d){d<k.length&&e.get("http://"+c()+"/ad/"+a+"/childs").then(function(a){var c=a.data;b.forEach(c,function(a){a.$$index=d}),c.unshift(m),g[k[d]+"s"]=c,g[k[d]]=m;for(var e=d+1;e<k.length;e++)g[k[e]+"s"]=[m],g[k[e]]=m})},g.loadADInfo=function(c,e){if(d()&&e<3){var f,h=[m];f=0===e?a.adData:c.childs,b.forEach(f,function(a){h.push({id:a.i,name:unescape(a.n.replace(/\\u/g,"%u")),childs:a.c,$$index:e})}),g[k[e]+"s"]=h,g[k[e]]=m;for(var i=e+1;i<k.length;i++)g[k[i]+"s"]=[m],g[k[i]]=m}else g.refreshADInfo(c.id,e)},g.loadADInfo({id:0},0),g.change=function(a){var b=k[a],c=g[b];l[b].id=c.id,l[b].name=c.name};for(var n=function(a){f(function(){if(a){var b=a.$$index;if(null===a.name||""===a.name){g[k[b]]=m;for(var c=b+1;c<k.length;c++)g[k[c]]=m,g[k[c]+"s"]=[m]}else for(var d=g[k[b]+"s"],e=0;e<d.length;e++){var f=d[e];if(a.id&&f.id===a.id||f.name===a.name)return g[k[b]]=f,void g.loadADInfo(f,b+1)}}},0)},o=0;o<k.length;o++)l.$watch(k[o],n,!0)}}}])}(window,angular);