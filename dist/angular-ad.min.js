/*! cjoop-ad-angular - v0.1.1 - 2016-10-08
* https://github.com/cjjava/cjoop-ad-angular
* Copyright (c) 2016 cjjava <85309651@qq.com>; Licensed MIT */
!function(a,b){"use strict";function c(){return a.adhost||"localhost:80"}function d(){return b.isArray(a.adData)&&a.adData.length>0}b.module("cjoop.ad",[]).directive("ad",["$http",function(e){return{scope:{},template:function(a,c){var d=c.bindModel;if(!d)throw new Error("The bind-model must not be null");var e=d.split(","),f=new Array(e.length);return f.push('<div class="ad-wrapper">'),b.forEach(e,function(a,b){f.push('<select ng-change="change('+b+')" class="ad-select {{'+a+'_class}}" ng-model="'+a+'" ng-options="'+a+".name for "+a+" in "+a+'s"></select>\n')}),f.push("</div>"),f.join("")},link:function(f,g,h){var i=h.bindModel,j=i.split(","),k=f.$parent;h["class"]||(h["class"]="");var l=h["class"].split(",");g.removeClass(h["class"]);var m={id:"",name:"请选择",$$index:-1};b.forEach(j,function(a,c){f[a+"s"]=[m],f[a]=m,l.length>1?c<l.length?f[a+"_class"]=l[c]:f[a+"_class"]="":f[a+"_class"]=l[0];var d=k[a];if(d||(d={id:"",name:"请选择"}),!b.isObject(d))throw new Error("scope."+a+"不是一个json对象.");d.$$index=c,k[a]=d}),f.refreshADInfo=function(a,d){d<j.length&&e.get("http://"+c()+"/ad/"+a+"/childs").then(function(a){var c=a.data;b.forEach(c,function(a){a.$$index=d}),c.unshift(m),f[j[d]+"s"]=c,f[j[d]]=m;for(var e=d+1;e<j.length;e++)f[j[e]+"s"]=[m],f[j[e]]=m})},f.loadADInfo=function(c,e){if(d()&&e<3){var g,h=[m];g=0===e?a.adData:c.childs,b.forEach(g,function(a){h.push({id:a.i,name:unescape(a.n.replace(/\\u/g,"%u")),childs:a.c,$$index:e})}),f[j[e]+"s"]=h,f[j[e]]=m;for(var i=e+1;i<j.length;i++)f[j[i]+"s"]=[m],f[j[i]]=m}else f.refreshADInfo(c.id,e)},f.loadADInfo({id:0},0),f.change=function(a){var b=j[a],c=f[b];k[b].id=c.id,k[b].name=c.name,k[b].$$index=a;for(var d=a+1;d<j.length;d++)k[j[d]].id="",k[j[d]].name="";f.loadADInfo(c,a+1)};for(var n=function(a){if(a){var b=a.$$index;if(null===a.name||""===a.name){f[j[b]]=m;for(var c=b+1;c<j.length;c++)f[j[c]]=m,f[j[c]+"s"]=[m],k[j[c]].id="",k[j[c]].name=""}else{var d=f[j[b]+"s"];if(d)for(var e=0;e<d.length;e++){var g=d[e];if(a.id&&g.id===a.id||g.name===a.name)return f[j[b]]=g,f.loadADInfo(g,b+1),a.id=g.id,void(a.name=g.name)}}}},o=0;o<j.length;o++)k.$watch(j[o],n,!0)}}}])}(window,angular);